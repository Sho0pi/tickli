package cmd

import (
	"fmt"
	"github.com/joho/godotenv"
	"github.com/pkg/browser"
	"github.com/pkg/errors"
	"net/http"
	"os"

	"github.com/rs/zerolog/log"
	"github.com/sho0pi/tickli/internal/api"
	"github.com/sho0pi/tickli/internal/config"
	"github.com/spf13/cobra"
)

var logo = `+---------------------------------------------+
|[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;48;29;46m.[0m[38;2;46;28;44m.[0m[38;2;45;27;43m.[0m[38;2;45;27;43m.[0m[38;2;42;25;41m.[0m[38;2;40;24;39m.[0m[38;2;39;23;36m.[0m[38;2;38;23;36m [0m[38;2;35;21;34m [0m[38;2;35;21;34m [0m[38;2;33;19;32m [0m[38;2;32;18;31m [0m[38;2;30;16;29m [0m[38;2;29;15;28m [0m[38;2;27;13;26m [0m[38;2;27;13;26m [0m[38;2;27;13;26m [0m[38;2;26;12;25m [0m[38;2;25;11;24m [0m[38;2;26;12;25m [0m[38;2;26;12;25m [0m[38;2;25;11;24m [0m[38;2;25;11;24m [0m[38;2;26;12;25m [0m[38;2;26;12;25m [0m[38;2;26;13;25m [0m[38;2;27;13;26m [0m[38;2;29;13;26m [0m[38;2;29;12;26m [0m[38;2;29;11;27m [0m[38;2;29;11;27m [0m[38;2;29;11;27m [0m[38;2;31;11;28m [0m[38;2;32;11;28m [0m[38;2;32;11;28m [0m[38;2;32;11;28m [0m|
|[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;51;30;49m.[0m[38;2;51;30;49m.[0m[38;2;51;30;49m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;48;29;46m.[0m[38;2;46;28;44m.[0m[38;2;45;27;43m.[0m[38;2;44;26;42m.[0m[38;2;42;25;41m.[0m[38;2;41;24;39m.[0m[38;2;39;23;36m.[0m[38;2;38;23;36m [0m[38;2;35;21;34m [0m[38;2;34;20;33m [0m[38;2;33;19;32m [0m[38;2;33;19;32m [0m[38;2;31;17;30m [0m[38;2;30;16;29m [0m[38;2;29;15;28m [0m[38;2;28;14;27m [0m[38;2;28;14;27m [0m[38;2;27;13;26m [0m[38;2;27;13;26m [0m[38;2;27;13;26m [0m[38;2;27;13;26m [0m[38;2;26;12;25m [0m[38;2;26;12;25m [0m[38;2;26;12;25m [0m[38;2;27;13;26m [0m[38;2;29;12;27m [0m[38;2;30;12;27m [0m[38;2;31;12;27m [0m[38;2;31;11;28m [0m[38;2;31;11;28m [0m[38;2;31;11;28m [0m[38;2;31;11;28m [0m[38;2;32;11;29m [0m[38;2;33;11;30m [0m[38;2;33;11;30m [0m[38;2;33;11;30m [0m|
|[0m[38;2;49;28;47m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;48;28;46m.[0m[38;2;46;28;44m.[0m[38;2;46;27;43m.[0m[38;2;43;25;42m.[0m[38;2;41;24;41m.[0m[38;2;41;24;39m.[0m[38;2;39;23;37m.[0m[38;2;39;23;36m.[0m[38;2;38;23;36m.[0m[38;2;38;24;35m.[0m[38;2;39;24;34m.[0m[38;2;39;24;34m.[0m[38;2;37;24;34m [0m[38;2;34;20;32m [0m[38;2;30;17;30m [0m[38;2;29;15;27m [0m[38;2;28;14;27m [0m[38;2;27;14;27m [0m[38;2;28;14;27m [0m[38;2;27;13;26m [0m[38;2;27;13;26m [0m[38;2;27;13;26m [0m[38;2;28;13;27m [0m[38;2;29;12;27m [0m[38;2;30;12;27m [0m[38;2;31;12;28m [0m[38;2;32;11;28m [0m[38;2;32;11;28m [0m[38;2;33;10;29m [0m[38;2;33;11;30m [0m[38;2;33;11;30m [0m[38;2;34;11;30m [0m[38;2;34;12;31m [0m[38;2;35;12;32m [0m[38;2;35;12;32m [0m[38;2;35;12;32m [0m|
|[0m[38;2;47;26;45m.[0m[38;2;48;27;46m.[0m[38;2;49;28;47m.[0m[38;2;50;29;48m.[0m[38;2;50;29;48m.[0m[38;2;49;28;47m.[0m[38;2;49;28;47m.[0m[38;2;49;28;47m.[0m[38;2;48;27;46m.[0m[38;2;46;27;44m.[0m[38;2;45;27;43m.[0m[38;2;45;27;43m.[0m[38;2;44;26;42m.[0m[38;2;45;28;40m.[0m[38;2;52;32;39m.[0m[38;2;61;39;40m.[0m[38;2;81;56;48m.[0m[38;2;109;85;64m;[0m[38;2;133;112;80mc[0m[38;2;153;127;84ml[0m[38;2;163;133;83mo[0m[38;2;154;126;80ml[0m[38;2;87;65;51m'[0m[38;2;43;27;35m.[0m[38;2;32;18;32m [0m[38;2;30;15;29m [0m[38;2;28;14;27m [0m[38;2;28;14;27m [0m[38;2;28;14;27m [0m[38;2;28;14;27m [0m[38;2;29;14;27m [0m[38;2;30;13;27m [0m[38;2;31;11;28m [0m[38;2;32;11;28m [0m[38;2;33;11;30m [0m[38;2;33;11;30m [0m[38;2;34;10;30m [0m[38;2;35;11;31m [0m[38;2;36;11;32m [0m[38;2;36;12;32m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m|
|[0m[38;2;44;26;43m.[0m[38;2;45;27;43m.[0m[38;2;46;27;44m.[0m[38;2;46;27;44m.[0m[38;2;46;27;44m.[0m[38;2;46;27;44m.[0m[38;2;45;27;43m.[0m[38;2;46;27;43m.[0m[38;2;45;27;43m.[0m[38;2;45;27;44m.[0m[38;2;49;29;43m.[0m[38;2;58;34;40m.[0m[38;2;78;51;42m.[0m[38;2;127;97;72m:[0m[38;2;179;146;102md[0m[38;2;220;180;124mO[0m[38;2;246;201;137mK[0m[38;2;254;206;131mK[0m[38;2;253;203;117mK[0m[38;2;250;196;104m0[0m[38;2;246;193;101m0[0m[38;2;243;192;107m0[0m[38;2;147;115;74mc[0m[38;2;52;33;37m.[0m[38;2;34;20;32m [0m[38;2;30;16;29m [0m[38;2;29;15;28m [0m[38;2;29;16;28m [0m[38;2;30;15;28m [0m[38;2;31;13;27m [0m[38;2;32;11;28m [0m[38;2;32;12;28m [0m[38;2;33;12;30m [0m[38;2;33;12;30m [0m[38;2;35;11;30m [0m[38;2;35;11;31m [0m[38;2;36;12;32m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m|
|[0m[38;2;41;24;40m.[0m[38;2;41;24;40m.[0m[38;2;42;25;41m.[0m[38;2;43;26;42m.[0m[38;2;44;26;42m.[0m[38;2;44;26;42m.[0m[38;2;44;26;42m.[0m[38;2;45;26;42m.[0m[38;2;46;28;42m.[0m[38;2;57;33;40m.[0m[38;2;90;59;46m'[0m[38;2;168;135;93mo[0m[38;2;231;189;130m0[0m[38;2;253;191;130m0[0m[38;2;253;171;113mO[0m[38;2;253;166;103mO[0m[38;2;243;163;99mk[0m[38;2;210;145;85mx[0m[38;2;175;124;72ml[0m[38;2;145;106;67mc[0m[38;2;123;94;64m:[0m[38;2;93;70;55m'[0m[38;2;54;36;39m.[0m[38;2;37;23;33m [0m[38;2;31;18;29m [0m[38;2;30;16;29m [0m[38;2;30;16;29m [0m[38;2;30;16;29m [0m[38;2;30;15;28m [0m[38;2;31;13;27m [0m[38;2;36;28;46m.[0m[38;2;53;91;113m,[0m[38;2;53;131;150m:[0m[38;2;53;125;145m:[0m[38;2;43;64;86m.[0m[38;2;36;17;35m [0m[38;2;37;11;32m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m|
|[0m[38;2;38;25;39m.[0m[38;2;39;25;39m.[0m[38;2;39;26;40m.[0m[38;2;39;25;41m.[0m[38;2;39;25;41m.[0m[38;2;38;25;41m.[0m[38;2;41;25;41m.[0m[38;2;50;29;40m.[0m[38;2;69;41;38m.[0m[38;2;137;103;73m:[0m[38;2;227;182;126mO[0m[38;2;253;176;119m0[0m[38;2;252;154;103mk[0m[38;2;247;154;102mk[0m[38;2;200;130;84md[0m[38;2;136;91;63m:[0m[38;2;84;56;46m.[0m[38;2;57;37;38m.[0m[38;2;44;30;36m.[0m[38;2;38;24;34m.[0m[38;2;35;22;33m [0m[38;2;33;21;33m [0m[38;2;32;20;32m [0m[38;2;31;18;30m [0m[38;2;30;16;29m [0m[38;2;31;16;29m [0m[38;2;31;16;28m [0m[38;2;30;17;29m [0m[38;2;33;21;36m [0m[38;2;56;60;82m.[0m[38;2;93;155;187mo[0m[38;2;63;186;235md[0m[38;2;34;185;239md[0m[38;2;30;205;245mx[0m[38;2;56;188;213md[0m[38;2;36;41;64m.[0m[38;2;37;13;32m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m[38;2;37;12;33m [0m|
|[0m[38;2;34;24;35m [0m[38;2;35;25;36m [0m[38;2;35;25;36m.[0m[38;2;35;24;37m.[0m[38;2;35;25;38m.[0m[38;2;37;26;39m.[0m[38;2;49;30;38m.[0m[38;2;84;52;43m.[0m[38;2;185;145;103md[0m[38;2;250;186;128m0[0m[38;2;253;152;103mk[0m[38;2;250;153;104mk[0m[38;2;201;136;93md[0m[38;2;116;79;57m;[0m[38;2;61;41;40m.[0m[38;2;42;28;36m.[0m[38;2;35;24;36m [0m[38;2;30;23;33m [0m[38;2;29;23;33m [0m[38;2;29;21;32m [0m[38;2;30;20;31m [0m[38;2;30;19;31m [0m[38;2;30;19;31m [0m[38;2;29;18;30m [0m[38;2;29;17;29m [0m[38;2;29;17;29m [0m[38;2;33;19;33m [0m[38;2;61;42;66m.[0m[38;2;127;107;149mc[0m[38;2;136;130;203mo[0m[38;2;89;110;206mc[0m[38;2;62;125;217mc[0m[38;2;57;160;228mo[0m[38;2;69;173;213md[0m[38;2;52;91;118m,[0m[38;2;35;20;41m [0m[38;2;36;11;30m [0m[38;2;36;11;31m [0m[38;2;36;11;32m [0m[38;2;36;12;32m [0m[38;2;36;12;32m [0m[38;2;36;12;32m [0m[38;2;36;12;32m [0m[38;2;35;11;32m [0m[38;2;35;11;32m [0m|
|[0m[38;2;29;22;33m [0m[38;2;30;23;33m [0m[38;2;31;23;34m [0m[38;2;32;24;35m [0m[38;2;33;24;35m [0m[38;2;41;28;38m.[0m[38;2;70;42;38m.[0m[38;2;186;144;101md[0m[38;2;252;179;122m0[0m[38;2;252;148;98mk[0m[38;2;249;164;109mO[0m[38;2;168;120;82ml[0m[38;2;75;51;41m.[0m[38;2;47;33;39m.[0m[38;2;35;25;36m.[0m[38;2;31;24;34m [0m[38;2;30;23;33m [0m[38;2;29;23;33m [0m[38;2;29;23;34m [0m[38;2;29;22;34m [0m[38;2;28;19;32m [0m[38;2;28;19;32m [0m[38;2;28;19;32m [0m[38;2;27;18;32m [0m[38;2;28;18;32m [0m[38;2;37;24;42m.[0m[38;2;114;81;120m;[0m[38;2;186;124;206md[0m[38;2;153;93;205ml[0m[38;2;118;78;196m:[0m[38;2;103;88;197m:[0m[38;2;107;135;210mo[0m[38;2;83;121;156mc[0m[38;2;42;44;66m.[0m[38;2;34;13;32m [0m[38;2;34;11;29m [0m[38;2;32;12;29m [0m[38;2;33;11;29m [0m[38;2;33;11;30m [0m[38;2;33;11;30m [0m[38;2;33;11;30m [0m[38;2;33;11;30m [0m[38;2;33;11;30m [0m[38;2;33;11;30m [0m[38;2;33;11;30m [0m|
|[0m[38;2;27;20;30m [0m[38;2;27;21;31m [0m[38;2;28;22;32m [0m[38;2;29;23;33m [0m[38;2;33;24;33m [0m[38;2;49;31;37m.[0m[38;2;124;91;65m;[0m[38;2;250;186;125m0[0m[38;2;252;155;97mk[0m[38;2;252;166;101mO[0m[38;2;193;149;104mx[0m[38;2;75;51;41m.[0m[38;2;43;32;38m.[0m[38;2;32;27;37m.[0m[38;2;28;26;35m [0m[38;2;31;27;36m.[0m[38;2;53;36;45m.[0m[38;2;86;58;72m'[0m[38;2;85;58;78m'[0m[38;2;50;33;50m.[0m[38;2;31;22;35m [0m[38;2;27;20;32m [0m[38;2;27;20;32m [0m[38;2;35;22;40m [0m[38;2;79;58;84m'[0m[38;2;169;122;177mo[0m[38;2;200;117;221md[0m[38;2;165;83;210ml[0m[38;2;149;78;205mc[0m[38;2;150;90;205mc[0m[38;2;126;93;167mc[0m[38;2;64;53;84m.[0m[38;2;33;20;36m [0m[38;2;30;13;29m [0m[38;2;31;11;28m [0m[38;2;31;11;28m [0m[38;2;31;11;28m [0m[38;2;31;11;28m [0m[38;2;31;11;28m [0m[38;2;31;11;28m [0m[38;2;31;11;27m [0m[38;2;31;11;28m [0m[38;2;31;11;28m [0m[38;2;31;11;28m [0m[38;2;31;11;28m [0m|
|[0m[38;2;20;19;27m [0m[38;2;21;20;28m [0m[38;2;23;22;30m [0m[38;2;23;23;29m [0m[38;2;29;26;30m [0m[38;2;55;36;34m.[0m[38;2;171;131;92mo[0m[38;2;251;173;101mO[0m[38;2;252;166;90mO[0m[38;2;252;199;126mK[0m[38;2;132;106;81mc[0m[38;2;49;37;35m.[0m[38;2;29;27;34m [0m[38;2;24;25;33m [0m[38;2;28;25;33m [0m[38;2;89;60;58m'[0m[38;2;218;136;126mx[0m[38;2;240;119;136mx[0m[38;2;242;121;171mx[0m[38;2;224;137;200mk[0m[38;2;165;115;158mo[0m[38;2;95;71;94m,[0m[38;2;69;48;73m.[0m[38;2;156;114;160ml[0m[38;2;225;134;230mk[0m[38;2;218;95;234md[0m[38;2;198;81;225ml[0m[38;2;188;92;220mo[0m[38;2;173;103;200mo[0m[38;2;107;67;121m,[0m[38;2;41;23;45m.[0m[38;2;26;13;27m [0m[38;2;26;12;26m [0m[38;2;26;12;27m [0m[38;2;26;15;30m [0m[38;2;25;18;36m [0m[38;2;24;20;39m [0m[38;2;25;19;38m [0m[38;2;25;16;33m [0m[38;2;27;13;27m [0m[38;2;27;11;25m [0m[38;2;25;10;25m [0m[38;2;25;11;25m [0m[38;2;25;11;24m [0m[38;2;25;11;24m [0m|
|[0m[38;2;17;17;25m [0m[38;2;18;18;26m [0m[38;2;18;18;26m [0m[38;2;20;20;28m [0m[38;2;27;24;30m [0m[38;2;54;36;32m.[0m[38;2;180;140;97md[0m[38;2;253;178;93mO[0m[38;2;253;181;87m0[0m[38;2;252;214;142mX[0m[38;2;116;94;76m:[0m[38;2;42;34;34m.[0m[38;2;24;25;31m [0m[38;2;21;23;31m [0m[38;2;24;22;30m [0m[38;2;64;45;43m.[0m[38;2;176;117;90ml[0m[38;2;236;134;106mx[0m[38;2;247;108;115md[0m[38;2;252;98;151md[0m[38;2;251;112;195mx[0m[38;2;246;137;216mk[0m[38;2;238;139;220mk[0m[38;2;246;108;236mx[0m[38;2;244;88;244md[0m[38;2;232;88;241md[0m[38;2;215;107;229md[0m[38;2;145;89;156mc[0m[38;2;55;34;63m.[0m[38;2;24;13;25m [0m[38;2;21;10;21m [0m[38;2;21;10;22m [0m[38;2;21;11;24m [0m[38;2;21;17;33m [0m[38;2;23;34;61m.[0m[38;2;62;102;141m;[0m[38;2;92;146;190mo[0m[38;2;93;146;185mo[0m[38;2;45;75;105m'[0m[38;2;19;22;42m [0m[38;2;18;12;25m [0m[38;2;20;10;21m [0m[38;2;20;10;21m [0m[38;2;20;11;22m [0m[38;2;19;11;22m [0m|
|[0m[38;2;15;15;23m [0m[38;2;16;16;24m [0m[38;2;17;17;25m [0m[38;2;18;17;25m [0m[38;2;22;22;27m [0m[38;2;44;35;33m.[0m[38;2;157;126;93ml[0m[38;2;251;184;98m0[0m[38;2;251;186;90m0[0m[38;2;251;216;139mX[0m[38;2;145;125;105ml[0m[38;2;48;37;34m.[0m[38;2;25;24;29m [0m[38;2;20;20;29m [0m[38;2;20;20;28m [0m[38;2;20;20;29m [0m[38;2;30;24;30m [0m[38;2;69;49;47m.[0m[38;2;149;92;85m:[0m[38;2;221;113;120md[0m[38;2;247;99;134md[0m[38;2;251;82;147mo[0m[38;2;254;79;176mo[0m[38;2;253;84;208md[0m[38;2;247;105;233mx[0m[38;2;208;118;210md[0m[38;2;99;64;104m,[0m[38;2;28;17;33m [0m[38;2;17;12;22m [0m[38;2;17;11;21m [0m[38;2;18;11;21m [0m[38;2;17;11;20m [0m[38;2;16;14;26m [0m[38;2;19;24;44m [0m[38;2;53;88;128m,[0m[38;2;108;171;246mx[0m[38;2;96;161;244md[0m[38;2;114;185;249mk[0m[38;2;79;128;168mc[0m[38;2;20;30;54m.[0m[38;2;19;19;37m [0m[38;2;18;18;35m [0m[38;2;19;20;37m [0m[38;2;19;22;40m [0m[38;2;19;22;41m [0m|
|[0m[38;2;15;15;23m [0m[38;2;15;15;23m [0m[38;2;15;15;23m [0m[38;2;16;16;24m [0m[38;2;19;18;25m [0m[38;2;31;26;31m [0m[38;2;91;72;58m,[0m[38;2;230;189;131m0[0m[38;2;239;184;103mO[0m[38;2;243;203;132mK[0m[38;2;216;197;168m0[0m[38;2;79;65;59m'[0m[38;2;36;30;32m.[0m[38;2;21;21;28m [0m[38;2;18;18;26m [0m[38;2;17;17;25m [0m[38;2;18;17;26m [0m[38;2;17;17;25m [0m[38;2;20;18;26m [0m[38;2;41;30;36m.[0m[38;2;104;68;74m,[0m[38;2;169;94;115mc[0m[38;2;202;101;150mo[0m[38;2;188;104;161mo[0m[38;2;125;84;121m:[0m[38;2;44;30;48m.[0m[38;2;18;13;23m [0m[38;2;15;12;21m [0m[38;2;15;12;22m [0m[38;2;15;12;21m [0m[38;2;15;12;21m [0m[38;2;14;14;22m [0m[38;2;17;20;37m [0m[38;2;25;48;78m.[0m[38;2;89;140;206ml[0m[38;2;85;138;248mo[0m[38;2;96;154;249md[0m[38;2;121;188;242mk[0m[38;2;43;83;118m'[0m[38;2;21;34;63m.[0m[38;2;20;30;55m.[0m[38;2;20;31;55m.[0m[38;2;21;32;57m.[0m[38;2;21;32;58m.[0m[38;2;21;32;59m.[0m|
|[0m[38;2;14;14;22m [0m[38;2;15;15;23m [0m[38;2;15;15;23m [0m[38;2;15;15;24m [0m[38;2;15;16;25m [0m[38;2;19;19;27m [0m[38;2;41;33;33m.[0m[38;2;131;111;94mc[0m[38;2;229;190;145m0[0m[38;2;231;186;132m0[0m[38;2;242;215;177mX[0m[38;2;207;194;183m0[0m[38;2;89;75;70m,[0m[38;2;38;31;34m.[0m[38;2;20;21;27m [0m[38;2;16;16;24m [0m[38;2;16;16;24m [0m[38;2;17;17;25m [0m[38;2;16;17;24m [0m[38;2;16;17;23m [0m[38;2;16;17;24m [0m[38;2;19;18;26m [0m[38;2;24;20;29m [0m[38;2;22;19;28m [0m[38;2;17;16;24m [0m[38;2;14;15;23m [0m[38;2;15;14;23m [0m[38;2;15;13;21m [0m[38;2;15;13;21m [0m[38;2;15;13;22m [0m[38;2;15;15;27m [0m[38;2;17;23;43m [0m[38;2;33;58;90m.[0m[38;2;95;145;200mo[0m[38;2;90;142;249mo[0m[38;2;88;138;249mo[0m[38;2;115;176;246mx[0m[38;2;72;126;165mc[0m[38;2;22;46;82m.[0m[38;2;21;34;64m.[0m[38;2;21;32;60m.[0m[38;2;22;33;60m.[0m[38;2;22;33;61m.[0m[38;2;22;33;62m.[0m[38;2;22;33;63m.[0m|
|[0m[38;2;13;16;24m [0m[38;2;13;16;25m [0m[38;2;13;16;25m [0m[38;2;13;15;26m [0m[38;2;13;15;27m [0m[38;2;15;16;27m [0m[38;2;22;20;27m [0m[38;2;42;34;34m.[0m[38;2;117;100;90m:[0m[38;2;210;179;157mO[0m[38;2;223;190;168m0[0m[38;2;233;213;204mX[0m[38;2;227;217;215mX[0m[38;2;153;144;144md[0m[38;2;66;61;62m.[0m[38;2;30;29;34m.[0m[38;2;22;21;29m [0m[38;2;19;19;27m [0m[38;2;18;19;26m [0m[38;2;20;20;28m [0m[38;2;21;21;29m [0m[38;2;21;22;30m [0m[38;2;21;22;29m [0m[38;2;21;22;29m [0m[38;2;21;21;29m [0m[38;2;21;21;28m [0m[38;2;19;19;27m [0m[38;2;18;19;28m [0m[38;2;17;20;30m [0m[38;2;17;24;42m [0m[38;2;28;50;76m.[0m[38;2;70;115;157m:[0m[38;2;101;156;228md[0m[38;2;88;140;247mo[0m[38;2;88;140;249mo[0m[38;2;109;167;234mx[0m[38;2;68;116;156m:[0m[38;2;22;49;85m.[0m[38;2;22;37;66m.[0m[38;2;21;33;60m.[0m[38;2;21;33;61m.[0m[38;2;21;33;62m.[0m[38;2;23;34;63m.[0m[38;2;23;34;63m.[0m[38;2;23;34;63m.[0m|
|[0m[38;2;13;15;27m [0m[38;2;13;15;27m [0m[38;2;13;15;27m [0m[38;2;13;15;26m [0m[38;2;13;15;27m [0m[38;2;13;15;28m [0m[38;2;14;16;27m [0m[38;2;17;19;27m [0m[38;2;29;27;29m [0m[38;2;67;56;53m.[0m[38;2;155;136;130mo[0m[38;2;206;185;183mO[0m[38;2;212;195;199m0[0m[38;2;226;215;218mX[0m[38;2;222;217;221mX[0m[38;2;170;168;172mk[0m[38;2;121;120;124mc[0m[38;2;77;78;84m,[0m[38;2;46;48;57m.[0m[38;2;41;44;53m.[0m[38;2;40;43;53m.[0m[38;2;41;44;53m.[0m[38;2;41;44;55m.[0m[38;2;41;43;54m.[0m[38;2;40;44;54m.[0m[38;2;38;44;58m.[0m[38;2;36;48;67m.[0m[38;2;50;73;94m'[0m[38;2;69;106;134m;[0m[38;2;85;135;181ml[0m[38;2;104;162;233md[0m[38;2;92;147;250mo[0m[38;2;86;137;249mo[0m[38;2;98;153;244md[0m[38;2;84;138;191ml[0m[38;2;37;74;111m'[0m[38;2;22;43;75m.[0m[38;2;22;35;64m.[0m[38;2;21;33;61m.[0m[38;2;22;33;62m.[0m[38;2;23;34;64m.[0m[38;2;23;35;66m.[0m[38;2;22;35;66m.[0m[38;2;23;36;66m.[0m[38;2;23;36;66m.[0m|
|[0m[38;2;14;16;30m [0m[38;2;14;16;30m [0m[38;2;14;16;30m [0m[38;2;13;15;29m [0m[38;2;13;15;28m [0m[38;2;13;15;27m [0m[38;2;13;15;26m [0m[38;2;13;15;25m [0m[38;2;13;16;26m [0m[38;2;18;19;28m [0m[38;2;33;28;33m.[0m[38;2;74;67;68m'[0m[38;2;136;126;132ml[0m[38;2;180;169;181mk[0m[38;2;198;190;208m0[0m[38;2;205;202;221mK[0m[38;2;217;215;234mX[0m[38;2;224;225;241mN[0m[38;2;201;210;224mK[0m[38;2;172;188;205mO[0m[38;2;155;174;192mk[0m[38;2;142;166;184mx[0m[38;2;133;161;182md[0m[38;2;128;162;186md[0m[38;2;124;165;194md[0m[38;2;121;171;210mx[0m[38;2;125;181;231mk[0m[38;2;125;185;249mk[0m[38;2;107;167;251mx[0m[38;2;95;151;250md[0m[38;2;93;148;249mo[0m[38;2;93;150;231mo[0m[38;2;76;127;184mc[0m[38;2;44;83;122m,[0m[38;2;21;45;78m.[0m[38;2;22;35;66m.[0m[38;2;21;33;61m.[0m[38;2;22;33;62m.[0m[38;2;23;34;64m.[0m[38;2;23;35;66m.[0m[38;2;23;36;68m.[0m[38;2;23;37;69m.[0m[38;2;23;37;70m.[0m[38;2;23;38;70m.[0m[38;2;24;38;70m.[0m|
|[0m[38;2;16;18;34m [0m[38;2;15;17;34m [0m[38;2;15;17;33m [0m[38;2;14;16;32m [0m[38;2;14;16;30m [0m[38;2;14;16;29m [0m[38;2;14;16;29m [0m[38;2;13;15;28m [0m[38;2;13;15;27m [0m[38;2;13;15;27m [0m[38;2;14;16;27m [0m[38;2;18;18;27m [0m[38;2;24;24;31m [0m[38;2;38;38;45m.[0m[38;2;81;80;91m,[0m[38;2;116;117;136mc[0m[38;2;138;144;171md[0m[38;2;153;163;198mx[0m[38;2;165;181;224mO[0m[38;2;165;189;235mO[0m[38;2;160;191;240mO[0m[38;2;155;191;244mO[0m[38;2;145;188;247mO[0m[38;2;135;183;250mk[0m[38;2;127;176;249mk[0m[38;2;124;172;250mx[0m[38;2;114;163;243mx[0m[38;2;99;148;225mo[0m[38;2;87;135;203ml[0m[38;2;73;118;175mc[0m[38;2;50;90;135m,[0m[38;2;25;53;88m.[0m[38;2;21;40;71m.[0m[38;2;21;35;64m.[0m[38;2;21;33;61m.[0m[38;2;21;32;61m.[0m[38;2;21;34;64m.[0m[38;2;23;35;66m.[0m[38;2;23;36;68m.[0m[38;2;23;37;70m.[0m[38;2;23;38;71m.[0m[38;2;24;39;73m.[0m[38;2;25;41;74m.[0m[38;2;25;41;75m.[0m[38;2;26;41;75m.[0m|
|[0m[38;2;16;19;36m [0m[38;2;16;19;36m [0m[38;2;16;19;36m [0m[38;2;14;17;33m [0m[38;2;14;16;31m [0m[38;2;14;16;31m [0m[38;2;14;16;31m [0m[38;2;13;15;28m [0m[38;2;13;15;27m [0m[38;2;13;16;26m [0m[38;2;12;15;24m [0m[38;2;11;14;23m [0m[38;2;12;15;24m [0m[38;2;13;16;25m [0m[38;2;16;18;27m [0m[38;2;23;24;33m [0m[38;2;29;32;39m.[0m[38;2;37;40;49m.[0m[38;2;50;55;67m.[0m[38;2;64;73;90m'[0m[38;2;74;86;106m,[0m[38;2;78;93;116m;[0m[38;2;77;95;121m;[0m[38;2;75;94;122m;[0m[38;2;68;88;115m,[0m[38;2;60;80;107m,[0m[38;2;46;65;91m.[0m[38;2;37;53;77m.[0m[38;2;32;45;69m.[0m[38;2;25;39;64m.[0m[38;2;21;34;59m.[0m[38;2;20;32;57m.[0m[38;2;21;33;58m.[0m[38;2;21;33;58m.[0m[38;2;21;33;59m.[0m[38;2;22;33;62m.[0m[38;2;23;34;65m.[0m[38;2;24;36;68m.[0m[38;2;24;36;69m.[0m[38;2;24;38;71m.[0m[38;2;25;40;73m.[0m[38;2;25;41;74m.[0m[38;2;26;42;76m.[0m[38;2;26;42;76m.[0m[38;2;26;42;76m.[0m|
|[0m[38;2;16;19;36m [0m[38;2;16;19;36m [0m[38;2;16;19;36m [0m[38;2;14;17;33m [0m[38;2;14;16;31m [0m[38;2;14;16;31m [0m[38;2;14;16;31m [0m[38;2;13;15;28m [0m[38;2;13;15;27m [0m[38;2;13;16;26m [0m[38;2;12;15;24m [0m[38;2;11;14;23m [0m[38;2;11;14;23m [0m[38;2;11;14;23m [0m[38;2;11;14;23m [0m[38;2;13;15;25m [0m[38;2;15;17;25m [0m[38;2;18;19;27m [0m[38;2;21;22;29m [0m[38;2;23;25;33m [0m[38;2;25;27;35m [0m[38;2;29;30;37m.[0m[38;2;30;32;41m.[0m[38;2;30;32;44m.[0m[38;2;29;34;46m.[0m[38;2;27;34;49m.[0m[38;2;26;33;51m.[0m[38;2;24;32;51m.[0m[38;2;22;30;52m.[0m[38;2;21;29;52m.[0m[38;2;19;29;52m [0m[38;2;20;31;54m.[0m[38;2;20;32;56m.[0m[38;2;20;32;57m.[0m[38;2;21;32;59m.[0m[38;2;22;33;62m.[0m[38;2;23;34;65m.[0m[38;2;24;36;67m.[0m[38;2;23;37;69m.[0m[38;2;24;38;71m.[0m[38;2;25;40;73m.[0m[38;2;25;41;74m.[0m[38;2;26;42;76m.[0m[38;2;26;42;76m.[0m[38;2;26;42;76m.[0m|
|[0m[38;2;16;19;36m [0m[38;2;16;19;36m [0m[38;2;16;19;36m [0m[38;2;15;17;34m [0m[38;2;14;16;31m [0m[38;2;14;16;31m [0m[38;2;14;16;31m [0m[38;2;13;15;29m [0m[38;2;13;15;27m [0m[38;2;13;15;27m [0m[38;2;12;15;25m [0m[38;2;11;14;23m [0m[38;2;11;14;23m [0m[38;2;11;14;23m [0m[38;2;11;14;23m [0m[38;2;11;14;23m [0m[38;2;11;14;23m [0m[38;2;12;15;24m [0m[38;2;13;15;24m [0m[38;2;15;16;25m [0m[38;2;16;17;26m [0m[38;2;17;18;27m [0m[38;2;18;19;33m [0m[38;2;18;21;37m [0m[38;2;19;24;42m [0m[38;2;19;25;44m [0m[38;2;19;26;45m [0m[38;2;19;26;47m [0m[38;2;19;26;47m [0m[38;2;20;28;50m [0m[38;2;18;29;51m [0m[38;2;20;31;53m.[0m[38;2;20;32;56m.[0m[38;2;20;32;57m.[0m[38;2;21;32;60m.[0m[38;2;22;33;62m.[0m[38;2;23;34;64m.[0m[38;2;23;36;67m.[0m[38;2;23;38;71m.[0m[38;2;24;39;72m.[0m[38;2;25;40;73m.[0m[38;2;25;41;74m.[0m[38;2;26;42;76m.[0m[38;2;26;42;76m.[0m[38;2;26;42;76m.[0m|
|[0m[38;2;16;19;36m [0m[38;2;16;19;36m [0m[38;2;16;19;36m [0m[38;2;15;18;34m [0m[38;2;14;16;31m [0m[38;2;14;16;31m [0m[38;2;14;16;31m [0m[38;2;13;15;29m [0m[38;2;13;15;27m [0m[38;2;13;15;27m [0m[38;2;13;15;25m [0m[38;2;11;14;23m [0m[38;2;11;14;23m [0m[38;2;11;14;23m [0m[38;2;11;14;23m [0m[38;2;11;14;23m [0m[38;2;11;14;23m [0m[38;2;11;14;23m [0m[38;2;11;14;23m [0m[38;2;11;14;23m [0m[38;2;12;15;22m [0m[38;2;13;16;27m [0m[38;2;16;17;34m [0m[38;2;18;20;38m [0m[38;2;19;23;42m [0m[38;2;17;24;42m [0m[38;2;18;25;44m [0m[38;2;19;25;47m [0m[38;2;18;26;47m [0m[38;2;20;28;50m [0m[38;2;19;29;52m [0m[38;2;20;31;54m.[0m[38;2;20;32;56m.[0m[38;2;20;32;57m.[0m[38;2;21;32;60m.[0m[38;2;23;34;62m.[0m[38;2;24;35;65m.[0m[38;2;24;36;68m.[0m[38;2;23;38;71m.[0m[38;2;24;39;72m.[0m[38;2;25;40;73m.[0m[38;2;25;41;74m.[0m[38;2;26;42;76m.[0m[38;2;26;42;76m.[0m[38;2;26;42;76m.[0m|
+---------------------------------------------+
`

var (
	clientID     string
	clientSecret string
)

func NewInitCommand() *cobra.Command {
	cmd := &cobra.Command{
		Use:   "init",
		Short: "Initialize tickli and obtain an access token",
		Long: `Initialize tickli by performing OAuth authentication with TickTick.
This will open your browser for authentication and store the access token securely.`,
		PreRun: func(cmd *cobra.Command, args []string) {
			fmt.Println(logo)
			if token, err := config.LoadToken(); err != nil {
				log.Fatal().Err(err).Msg("failed to check existing token")
			} else if token != "" {
				log.Fatal().Msg("tickli is already initialized. Used 'tickli reset' to reinitialize")
			}
		},
		Run: func(cmd *cobra.Command, args []string) {
			token, err := initTickli()
			if err != nil {
				log.Fatal().Err(err).Msg("Failed to initialize tickli")
			}
			log.Info().Str("token", token).Msg("Successfully initialized tickli!")
		},
	}

	return cmd
}

func initTickli() (string, error) {
	if err := godotenv.Load(); err == nil {
		log.Info().Msg("Loading TickTick credentials from .env")

		clientID = os.Getenv("TICKTICK_CLIENT_ID")
		clientSecret = os.Getenv("TICKTICK_CLIENT_SECRET")
	}

	// Verify credentials are available
	if clientID == "" || clientSecret == "" {
		return "", fmt.Errorf("missing TickTick credentials. Please provide them via environment variables or build flags")
	}

	// Start OAuth flow
	server := &http.Server{Addr: ":8080"}
	code := make(chan string, 1)

	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		code <- r.URL.Query().Get("code")
		fmt.Fprintf(w, "Authorization successful! You can close this window.")
		go func() {
			if err := server.Close(); err != nil {
				log.Error().Err(err).Msg("Failed to close server")
			}
		}()
	})

	authURL := api.GetAuthURL(clientID)
	if err := browser.OpenURL(authURL); err != nil {
		return "", errors.Wrap(err, "failed to open browser")
	}

	log.Info().Msg("Waiting for authorization...")
	go func() {
		if err := server.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			log.Error().Err(err).Msg("Server error")
		}
	}()

	// Get access token
	authCode := <-code
	token, err := api.GetAccessToken(clientID, clientSecret, authCode)
	if err != nil {
		return "", errors.Wrap(err, "failed to get access token")
	}

	if err := config.SaveToken(token); err != nil {
		return "", errors.Wrap(err, "failed to save token")
	}

	return token, nil
}
